[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
user=root

; ── PostgreSQL ────────────────────────────────────────────────────────
[program:postgres]
command=/usr/lib/postgresql/17/bin/postgres -D %(ENV_PGDATA)s -c listen_addresses=localhost -c log_destination=stderr
user=postgres
autostart=true
autorestart=true
priority=10
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; ── Cache process (ZeroMQ) ────────────────────────────────────────────
[program:cache]
command=poetry run python app_cache.py
directory=/app/latex-on-http
autostart=true
autorestart=true
priority=20
startsecs=2
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; ── Main API (gunicorn) ──────────────────────────────────────────────
; Waits for postgres (priority 10) and cache (priority 20) to start first.
[program:api]
command=poetry run gunicorn --workers=2 --threads=8 --bind=0.0.0.0:8080 app:app
directory=/app/latex-on-http
autostart=true
autorestart=true
priority=30
startsecs=5
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
